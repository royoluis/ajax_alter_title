<?php

use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\InvokeCommand;
use Drupal\Core\Ajax\HtmlCommand;

/**
 * @file
 * Primary module hooks for Ajax alter title module.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ajax_alter_title_form_node_page_edit_form_alter(&$form, $form_state, $form_id) {
	$form['canceled_title'] = [
		'#type' => 'button',
		'#value' => t('Add "Canceled" prefix'),
		'#ajax' => [
			'callback' => 'ajax_alter_title_cancel',
			'wrapper' => 'edit-title-0-value',
			'event' => 'click',
			'progress' => [
				'type' => 'throbber',
				'message' => 'Canceling title...'
			]
		]
	];

	$form['delete_title'] = [
		'#type' => 'button',
		'#value' => t('Delete preffix'),
		'#ajax' => [
			'callback' => 'ajax_alter_title_delete_prefix',
			'wrapper' => 'edit-title-0-value',
			'event' => 'click',
			'progress' => [
				'type' => 'throbber',
				'message' => 'Deleting preffix...'
			]
		]
	];

	$form['message_title'] = [
		'#type' => 'markup',
		'#markup' => '<div id="message-title"></div>',
	];

}

/**
 * AJAX callback to add the word 'Canceled' to node titles.
 */
function ajax_alter_title_cancel(&$form, &$form_state) {
  $response = new AjaxResponse();
	$current_title = $form['title']['widget'][0]['value']['#default_value'];
	$cancel_prefix = "CANCELED / ";

	if (!str_starts_with($current_title, $cancel_prefix)) {
    $new_title = $cancel_prefix . $current_title;
		$message = '<p style="color:red;">"' . $cancel_prefix . '" has been added. Please, <b>save this node</b></p>';
  }
	else {
    $new_title = $current_title;
		$message = '<p style="color:red;">"' . $cancel_prefix . '" is already in the original title.</p>';
  }

	$response->addCommand(new InvokeCommand('#edit-title-0-value', 'val', [$new_title]));
  $response->addCommand(new HtmlCommand('#message-title', $message));
  return $response;
}

/**
 * AJAX callback to add the word 'Canceled' to node titles.
 */
function ajax_alter_title_delete_prefix(&$form) {
  $response = new AjaxResponse();
	$current_title = $form['title']['widget'][0]['value']['#default_value'];
	$cancel_prefix = "CANCELED / ";

	if (str_starts_with($current_title, $cancel_prefix)) {
    $new_title = substr($current_title, strlen($cancel_prefix));
		$message = '<p style="color:red;">"' . $cancel_prefix . '" has been deleted. Please, <b>save this node</b></p>';
  }
	else {
    $new_title = $current_title;
		$message = '<p style="color:red;">There is no prefix in the original title. </p>';
  }

	$response->addCommand(new InvokeCommand('#edit-title-0-value', 'val', [$new_title]));
  $response->addCommand(new HtmlCommand('#message-title', $message));
  return $response;
}